if (!window.PDoc) window.PDoc = {};
PDoc.elements = {
<%= @root.map{|e| "  '#{e.full_name}': '#{path_to(e)}'"}.join(",\n") %>
};

PDoc.highlightSelected = function() {
  if (!window.location.hash) return;
  var element = $(window.location.hash.substr(1));
  if (element) element.highlight(PDoc.HighlightOptions);
};

PDoc.HighlightOptions = {
  startcolor: '#e4e4e4',
  restorecolor: true,
  queue: {
    position:'end',
    scope: 'global',
    limit: 1
  }
};

var Filterer = Class.create({
  initialize: function(element, options) {
    this.element = $(element);
    this.options = Object.extend({
      interval: 0.1,
      resultsElement: '.search-results'
    }, options || {});
    
    this.menu = this.options.menu;
    this.links = this.menu.select('a');
    
    this.resultsElement = this.menu.down(this.options.resultsElement);
    
    this.events = {
      filter:   this.filter.bind(this)
    };
    
    this.menu.setStyle({ opacity: 0.9 });
    this.addObservers();
    
    this.element.value = '';
  },
  
  addObservers: function() {
    this.element.observe('keyup', this.events.filter);
  },
  
  filter: function(event) {
    if (event.keyCode && event.keyCode === Event.KEY_ESC) {
      this.element.value = '';
    }
    
    var value = $F(this.element).strip().toLowerCase();
    
    if (value === "") {
      this.onEmpty();
      return;
    }
    
    var urls  = this.findURLs(value);    
    var match = function(elem) {
      return urls.any( function(url) { return elem.href.include(url); });
    };    

    var matchingLinks = this.links.select(match);    
    if (matchingLinks.length === 0) {
      this.onEmpty();
      return;
    }
    
    this.buildResults(matchingLinks);
  },
  
  buildResults: function(links) {
    this.resultsElement.update();
    var ul = new Element('ul');
    links.each( function(link) {
      ul.insert(link.cloneNode(true).wrap('li'));
    }, this);    
    this.resultsElement.insert(ul);
    this.resultsElement.show();
  },
  
  findURLs: function(str) {
    var results = [];
    for (var i in PDoc.elements) {
      if (i.toLowerCase().include(str)) results.push(PDoc.elements[i]);
    }
    return results;
  },
  
  onEmpty: function() {
    this.resultsElement.hide();
  }
});

document.observe('dom:loaded', function() {
  new Filterer($('search'), { menu: $('api_menu') });
});

document.observe('click', function(event) {
  var element = event.findElement('a');
  if (!element) return;
  var href = element.readAttribute('href');
  if (!href.include('#')) return;
  if (element = $(href.split('#').last()))
    element.highlight(PDoc.HighlightOptions);
});

document.observe('dom:loaded', PDoc.highlightSelected);;