if (!window.PDoc) window.PDoc = {};
PDoc.elements = {
  <%= @root.map { |e, i| "'#{e.full_name}': { 'name': '#{e.full_name}', 'type': '#{e.type}', 'path': '#{path_to(e)}' }" }.join(",\n") %>
};

PDoc.highlightSelected = function(element) {
  if (!window.location.hash) return;
  element = (element || $(window.location.hash.substr(1)));
  if (element) {
    var alreadyHighlighted = $$('ul.method-details-list li.highlighted').first();
    if (alreadyHighlighted) alreadyHighlighted.removeClassName('highlighted');

    element.highlight(PDoc.HighlightOptions);
    element.up('li').addClassName('highlighted');    
  }
};

PDoc.HighlightOptions = {
  startcolor: '#e4e4e4',
  restorecolor: true,
  queue: {
    position:'end',
    scope: 'global',
    limit: 1
  }
};

var Filterer = Class.create({
  initialize: function(element, options) {
    this.element = $(element);
    this.options = Object.extend({
      interval: 0.1,
      resultsElement: '.search-results'
    }, options || {});
    
    this.menu = this.options.menu;
    this.links = this.menu.select('a');
    
    this.resultsElement = this.options.resultsElement;
    
    this.events = {
      filter:   this.filter.bind(this)
    };
    
    this.menu.setStyle({ opacity: 0.9 });
    this.addObservers();
    
    this.element.value = '';
  },
  
  addObservers: function() {
    this.element.observe('keyup', this.events.filter);
  },
  
  filter: function(event) {
    if (event.keyCode && event.keyCode === Event.KEY_ESC) {
      this.element.value = '';
    }
    
    var value = $F(this.element).strip().toLowerCase();
    
    if (value === "") {
      this.onEmpty();
      return;
    }
    
    var urls  = this.findURLs(value);  
    console.log(urls);
    this.buildResults(urls);
  },
  
  buildResults: function(urls) {
    this.resultsElement.update();
    var ul = this.resultsElement;
    urls.each( function(url) {
      var a  = new Element('a', {
        'class': url.type.gsub(/\s/, '_'),
        href:    url.path
      }).update(url.name);
      var li = new Element('li');
      li.appendChild(a);
      ul.appendChild(li);
      console.log(li);
    });    
    this.resultsElement.show();
  },
  
  findURLs: function(str) {
    var results = [];
    for (var i in PDoc.elements) {
      if (i.toLowerCase().include(str)) results.push(PDoc.elements[i]);
    }
    return results;
  },
  
  onEmpty: function() {
    this.resultsElement.hide();
  }
});

document.observe('dom:loaded', function() {
  new Filterer($('search'), { menu: $('api_menu'), resultsElement: $('search_results') });
});

document.observe('click', function(event) {
  var element = event.findElement('a');
  if (!element) return;
  var href = element.readAttribute('href');
  if (!href.include('#')) return;
  if (element = $(href.split('#').last())) {
    PDoc.highlightSelected(element);
  }
});

document.observe('dom:loaded', function() { PDoc.highlightSelected() });